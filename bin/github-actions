#!/usr/bin/env bash

C_GRN=$'\033[32m'
C_RED=$'\033[31m'
C_YEL=$'\033[33m'
C_BLU=$'\033[34m'
C_GRY=$'\033[90m'
C_RST=$'\033[0m'

echo "Fetching GitHub workflows..."

selected_id=$(
    gh workflow list --all --limit 1000 --json id,name,state \
        --template '{{range .}}{{printf "%.0f\t%v\t_G_%v_R_\n" .id .name .state}}{{end}}' |
    column -t -s $'\t' |
    sed "s/_G_/${C_GRY}/g; s/_R_/${C_RST}/g" |
    fzf --ansi \
        --header "Select a Workflow" \
        --prompt "Workflow > " \
        --preview 'echo "Select a workflow to view its runs."' \
        --preview-window=up:2:hidden:wrap \
    | awk '{print $1}')

if [[ -n "$selected_id" ]]; then
    fetch_runs="
        gh run list --workflow $selected_id --limit 100 \
            --json databaseId,conclusion,status,headBranch,name,createdAt \
            --template '{{range .}}{{ \$s := .conclusion }}{{ \$c := \"_Y_\" }}{{ if eq \$s \"success\" }}{{ \$c = \"_G_\" }}{{ else if eq \$s \"failure\" }}{{ \$c = \"_R_\" }}{{ end }}{{ printf \"%.0f\t%s%v_rst_\t_B_%v_rst_\t%v\t_GR_%v_rst_\n\" .databaseId \$c .status .headBranch .name .createdAt }}{{ end }}' | \
        column -t -s $'\t' | \
        sed 's/_G_/\x1b[32m/g; s/_R_/\x1b[31m/g; s/_Y_/\x1b[33m/g; s/_B_/\x1b[34m/g; s/_GR_/\x1b[90m/g; s/_rst_/\x1b[0m/g'
    "
    eval "$fetch_runs" |
    fzf --ansi \
        --header "ctrl-r: Rerun failed | ctrl-o: Open in Browser" \
        --prompt "Run > " \
        --with-nth 2.. \
        --preview 'gh run view {1} | glow' \
        --bind "enter:execute(bash -c 'if echo \"{2}\" | grep -qE \"in_progress|queued\"; then gh run watch {1}; else gh run view {1} --log | less +G; fi')+reload($fetch_runs)" \
        --bind "ctrl-r:execute(gh run rerun {1} --failed)+reload($fetch_runs)" \
        --bind "ctrl-o:execute(gh run view {1} --web)"
fi
