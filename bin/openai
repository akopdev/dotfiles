#!/usr/bin/env bash

MODEL="gpt-4o-mini"
USER_PROMPT=()

if [ $# -lt 1 ]; then
cat << HELP
Usage: openai <prompt> [flags]

Flags:
  -m, --model   OpenAI Model, default: '${MODEL}'

HELP
return 
fi

if [[ -z "${OPENAI_API_KEY:-}" ]]; then
  print -u2 "Error: 'OPENAI_API_KEY' environment variable is not set"
  return
fi

while [[ $# -gt 0 ]]; do
  case $1 in
    -m|--model)
      MODEL="${2}"
      shift
      shift
      ;;
    *)
      USER_PROMPT+=("$1")
      shift
      ;;
  esac
done

if [[ ${#USER_PROMPT[@]} -eq 0 ]]; then
  echo "Error: prompt is required" >&2
  return
fi

curl -s https://api.openai.com/v1/responses \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -H "Content-Type: application/json" \
  -d "$(jq -n \
    --arg model "$MODEL" \
    --arg input "${USER_PROMPT[*]}" \
    '{
      model: $model,
      input: $input
    }'
  )" \
| jq -r '.output[0].content[0].text'
